<!DOCTYPE html>
<html lang="en" style="background: #f8fafc !important; background-color: #f8fafc !important;">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Module 1: Personal Choices | CALM 10 - Career and Life Managment</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css?family=Montserrat:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      background: #f8fafc !important;
      background-color: #f8fafc !important;
      font-family: 'Montserrat', sans-serif;
    }
    body {
      min-height: 100vh;
    }
    .custom-scroll::-webkit-scrollbar { width: 6px; }
    .custom-scroll::-webkit-scrollbar-track { background: #e2e8f0; }
    .custom-scroll::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 3px; }
    .glass { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(10px); }
    .material-card { transition: all 0.2s; }
    .material-card:hover { transform: translateY(-2px); box-shadow: 0 10px 40px rgba(0,0,0,0.3); }
    .assessment-container [class*="bg-slate-9"],
    .assessment-container [class*="bg-slate-8"],
    .assessment-container [class*="bg-slate-7"],
    .assessment-container [class*="bg-slate-6"],
    .assessment-container [class*="bg-gray-9"],
    .assessment-container [class*="bg-gray-8"],
    .assessment-container [class*="bg-gray-7"] {
      background: var(--cf-container-bg) !important;
    }
    :root { --cf-container-bg: rgba(255, 255, 255, 0.9); }
    
    
  </style>
  <script>
    (function() {
      function setBackground() {
        document.documentElement.style.backgroundColor = '#f8fafc';
        document.documentElement.style.background = '#f8fafc';
        if (document.body) {
          document.body.style.backgroundColor = '#f8fafc';
          document.body.style.background = '#f8fafc';
        }
      }
      setBackground();
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setBackground);
      }
      setTimeout(setBackground, 100);
      setTimeout(setBackground, 500);
    })();
  </script>
</head>
<body class="text-slate-900 custom-scroll" style="background: #f8fafc !important; background-color: #f8fafc !important;">
  <header class="sticky top-0 z-50 bg-white/95 backdrop-blur border-b border-slate-300">
    <div class="max-w-6xl mx-auto px-6 py-4 flex items-center justify-between">
      <a href="../index.html" class="flex items-center gap-2 text-slate-600 hover:text-indigo-400 transition-colors text-sm font-bold">
        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
        </svg>
        Back to Course
      </a>
      <h1 class="text-sm font-bold text-slate-900 uppercase tracking-wider">Module 1: Personal Choices</h1>
    </div>
  </header>

  <main class="max-w-6xl mx-auto px-6 py-8">
    
    <style>
      .cf-composer-activity {
        position: relative;
      }
      .cf-composer-activity.cf-block-font-override,
      .cf-composer-activity.cf-block-font-override * {
        font-family: var(--cf-block-font);
      }
      .cf-composer-activity.cf-block-text-override :is(h1, h2, h3, h4, h5, h6, p, span, div, li, ul, ol, label, summary, small, strong, em, blockquote, pre, a, button, input, textarea, select) {
        color: var(--cf-block-text);
      }
      .cf-composer-activity.cf-block-bg-override > :first-child {
        background: var(--cf-block-bg);
      }
      .cf-composer-activity.cf-block-border-override > :first-child,
      .cf-composer-activity.cf-block-border-override > :first-child [class*='border-'] {
        border-color: var(--cf-block-border);
      }
      .cf-composer-activity.cf-block-accent-override a,
      .cf-composer-activity.cf-block-accent-override [class*='text-indigo'],
      .cf-composer-activity.cf-block-accent-override [class*='text-sky'],
      .cf-composer-activity.cf-block-accent-override [class*='text-emerald'],
      .cf-composer-activity.cf-block-accent-override [class*='text-cyan'] {
        color: var(--cf-block-accent);
      }
    </style>
    <div
      class="grid gap-6"
      data-composer-root
      data-composer-columns="4"
      style="grid-template-columns: repeat(4, minmax(0, 1fr)); grid-auto-flow: row;"
    >
      
      <section
        data-activity-type="save_load_block"
        data-activity-id="activity-1771015649018-zx2mqt"
        data-block-theme="slate"
        data-composer-col-span="1"
        data-composer-row="2"
        data-composer-col="4"
        style="grid-column: 4 / span 1; grid-row: 2; --cf-block-text:#dbe3ee; --cf-block-bg:rgba(15, 23, 42, 0.82); --cf-block-border:rgba(71, 85, 105, 0.7); --cf-block-accent:#7dd3fc;"
        class="cf-composer-activity cf-block-text-override cf-block-bg-override cf-block-border-override cf-block-accent-override"
      >
        
        <article class="rounded-xl border border-cyan-500/30 bg-cyan-950/20 p-6" data-save-load-block data-save-load-file-name="calm10_unit1_personal_choices">
          <h3 class="text-lg font-bold text-cyan-300 mb-2">Save or Restore Progress</h3>
          <p class="text-xs text-cyan-100/90 leading-relaxed">Download a JSON backup of current responses, then upload it later to restore the module state.</p>
          <input type="file" accept=".json,application/json" class="hidden" data-save-load-upload-input />
          <div class="mt-3 flex flex-wrap gap-2">
            <button type="button" class="px-3 py-2 rounded bg-cyan-600 hover:bg-cyan-500 text-white text-xs font-bold uppercase tracking-wide" data-save-load-download>
              Download JSON
            </button>
            <button type="button" class="px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 text-slate-100 text-xs font-bold uppercase tracking-wide" data-save-load-upload-trigger>
              Upload JSON
            </button>
          </div>
          <p class="mt-3 text-xs text-cyan-100/75" data-save-load-status>No backup loaded yet.</p>
        </article>
      
      </section>
    

      <section
        data-activity-type="title_block"
        data-activity-id="activity-1771015657561-hb3z62"
        data-block-theme="slate"
        data-composer-col-span="4"
        data-composer-row="1"
        data-composer-col="1"
        style="grid-column: 1 / span 4; grid-row: 1; --cf-block-font:Bebas Neue, sans-serif; --cf-block-text:#dbe3ee; --cf-block-bg:rgba(15, 23, 42, 0.82); --cf-block-border:rgba(71, 85, 105, 0.7); --cf-block-accent:#7dd3fc;"
        class="cf-composer-activity cf-block-font-override cf-block-text-override cf-block-bg-override cf-block-border-override cf-block-accent-override"
      >
        
        <article class="rounded-xl border border-indigo-500/30 bg-indigo-950/20 p-5 text-left" data-title-block style="background:#737283;">
          <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Roboto:wght@400;700;900&family=Open+Sans:wght@400;700;800&family=Lato:wght@400;700;900&family=Montserrat:wght@400;700;900&family=Poppins:wght@400;700;900&family=Raleway:wght@400;700;900&family=Nunito:wght@400;700;900&family=Playfair+Display:wght@400;700;900&family=Merriweather:wght@400;700;900&family=Oswald:wght@400;700&family=Bebas+Neue&display=swap');
            .cf-title-content p { margin: 0.45rem 0; }
            .cf-title-content h1 { font-size: 2.5rem; line-height: 1.1; font-weight: 900; margin: 0.4rem 0; }
            .cf-title-content h2 { font-size: 2rem; line-height: 1.15; font-weight: 850; margin: 0.35rem 0; }
            .cf-title-content h3 { font-size: 1.5rem; line-height: 1.2; font-weight: 800; margin: 0.3rem 0; }
            .cf-title-content h4 { font-size: 1.25rem; line-height: 1.25; font-weight: 750; margin: 0.3rem 0; }
            .cf-title-content ul { list-style: disc; padding-left: 1.5rem; margin: 0.65rem 0; }
            .cf-title-content ol { list-style: decimal; padding-left: 1.5rem; margin: 0.65rem 0; }
            .cf-title-content li { margin: 0.2rem 0; }
            .cf-title-content a { color: #93c5fd; text-decoration: underline; }
            .cf-title-content blockquote { border-left: 3px solid #6366f1; margin: 0.75rem 0; padding-left: 0.8rem; opacity: 0.95; }
            .cf-title-content font[size='1'] { font-size: 0.75rem; }
            .cf-title-content font[size='2'] { font-size: 0.875rem; }
            .cf-title-content font[size='3'] { font-size: 1rem; }
            .cf-title-content font[size='4'] { font-size: 1.125rem; }
            .cf-title-content font[size='5'] { font-size: 1.25rem; }
            .cf-title-content font[size='6'] { font-size: 1.5rem; }
            .cf-title-content font[size='7'] { font-size: 1.875rem; }
          </style>
          <div class="cf-title-content text-white leading-tight"><h2><span style="color: rgb(250, 250, 250);">CALM MODULE 1: Personal Choices</span></h2></div>
        </article>
      
      </section>
    

      <section
        data-activity-type="resource_list"
        data-activity-id="activity-1771015668221-t95y5y"
        data-block-theme="default"
        data-composer-col-span="1"
        data-composer-row="2"
        data-composer-col="1"
        style="grid-column: 1 / span 1; grid-row: 2;"
        class="cf-composer-activity"
      >
        
        <article class="rounded-xl border border-slate-700 bg-slate-900/70 p-6">
          <h3 class="text-lg font-bold text-white mb-3">Resources</h3>
          <div class="hidden mb-4 rounded-lg border border-slate-700 overflow-hidden bg-black" data-resource-viewer>
            <div class="flex items-center justify-between bg-slate-800 border-b border-slate-700 px-3 py-2">
              <p class="text-xs font-bold uppercase tracking-widest text-white" data-resource-viewer-title>Resource Viewer</p>
              <button type="button" class="text-xs font-bold uppercase tracking-widest text-rose-300 hover:text-white" data-resource-viewer-close>Close</button>
            </div>
            <iframe src="" title="Resource viewer" class="w-full border-0" style="height: 70vh;" data-resource-viewer-frame></iframe>
          </div>
          <div class="hidden mb-4 rounded-lg border border-emerald-500/30 overflow-hidden bg-slate-950" data-resource-reader>
            <div class="flex items-center justify-between bg-slate-800 border-b border-slate-700 px-3 py-2">
              <p class="text-xs font-bold uppercase tracking-widest text-emerald-300" data-resource-reader-title>Digital Resource</p>
              <button type="button" class="text-xs font-bold uppercase tracking-widest text-rose-300 hover:text-white" data-resource-reader-close>Close</button>
            </div>
            <div class="flex" style="height: 70vh;">
              <aside class="hidden md:block w-64 border-r border-slate-800 bg-slate-900/70 p-3 overflow-y-auto custom-scroll">
                <p class="text-[10px] font-bold uppercase tracking-widest text-slate-400 mb-2">Contents</p>
                <div class="space-y-1" data-resource-reader-toc></div>
              </aside>
              <div class="flex-1 p-4 md:p-6 overflow-y-auto custom-scroll">
                <div data-resource-reader-body></div>
                <div class="mt-6 pt-4 border-t border-slate-800 flex items-center justify-between gap-3">
                  <button type="button" class="px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 text-white text-[11px] font-bold uppercase tracking-wide disabled:opacity-40" data-resource-reader-prev>Previous</button>
                  <p class="text-[11px] font-bold uppercase tracking-widest text-slate-400" data-resource-reader-progress></p>
                  <button type="button" class="px-3 py-2 rounded bg-slate-800 hover:bg-slate-700 text-white text-[11px] font-bold uppercase tracking-wide disabled:opacity-40" data-resource-reader-next>Next</button>
                </div>
              </div>
            </div>
          </div>
          <ul class="space-y-3 text-sm"><li class="rounded-lg border border-slate-700 bg-slate-950/70 p-4"><p class="text-slate-200 text-sm font-semibold">Resource link</p></li></ul>
        </article>
      
      </section>
    

      <section
        data-activity-type="step_sequence"
        data-activity-id="activity-1771015681701-2sd7dm"
        data-block-theme="default"
        data-composer-col-span="4"
        data-composer-row="3"
        data-composer-col="1"
        style="grid-column: 1 / span 4; grid-row: 3;"
        class="cf-composer-activity"
      >
        
        <article class="rounded-xl border border-slate-700 bg-slate-900/70 p-6">
          <h3 class="text-lg font-bold text-white mb-4">Step-by-Step Flow</h3>
          
              <ol class="space-y-3">
                
                    <li class="rounded-lg border border-slate-700 bg-slate-950/70 p-4">
                      <div class="flex items-start gap-3">
                        <div class="w-7 h-7 rounded-full bg-indigo-600/20 border border-indigo-500/50 text-indigo-300 text-xs font-bold flex items-center justify-center">1</div>
                        <div>
                          <h4 class="text-sm font-bold text-white">1. What Works For Me Inventory</h4>
                          <p class="text-sm text-slate-300 mt-1 leading-relaxed">Do your worksheet form.</p>
                        </div>
                      </div>
                    </li>
                  

                    <li class="rounded-lg border border-slate-700 bg-slate-950/70 p-4">
                      <div class="flex items-start gap-3">
                        <div class="w-7 h-7 rounded-full bg-indigo-600/20 border border-indigo-500/50 text-indigo-300 text-xs font-bold flex items-center justify-center">2</div>
                        <div>
                          <h4 class="text-sm font-bold text-white">Emotions &amp; Real-life Choices</h4>
                          <p class="text-sm text-slate-300 mt-1 leading-relaxed">Substances/Alcohol/Safety Scenarios and Rank &quot;risk reducers&quot;/&quot;supports&quot;</p>
                        </div>
                      </div>
                    </li>
                  

                    <li class="rounded-lg border border-slate-700 bg-slate-950/70 p-4">
                      <div class="flex items-start gap-3">
                        <div class="w-7 h-7 rounded-full bg-indigo-600/20 border border-indigo-500/50 text-indigo-300 text-xs font-bold flex items-center justify-center">3</div>
                        <div>
                          <h4 class="text-sm font-bold text-white">Healthy Habit Plan</h4>
                          <p class="text-sm text-slate-300 mt-1 leading-relaxed">Weekly habit actions/Self-assess &quot;Plan Quality&quot;</p>
                        </div>
                      </div>
                    </li>
                  

                    <li class="rounded-lg border border-slate-700 bg-slate-950/70 p-4">
                      <div class="flex items-start gap-3">
                        <div class="w-7 h-7 rounded-full bg-indigo-600/20 border border-indigo-500/50 text-indigo-300 text-xs font-bold flex items-center justify-center">4</div>
                        <div>
                          <h4 class="text-sm font-bold text-white">Artifact</h4>
                          <p class="text-sm text-slate-300 mt-1 leading-relaxed">&quot;Personal Wellness Plan&quot; </p>
                        </div>
                      </div>
                    </li>
                  
              </ol>
            
        </article>
      
      </section>
    

      <section
        data-activity-type="submission_builder"
        data-activity-id="activity-1771015768991-rgep8i"
        data-block-theme="slate"
        data-composer-col-span="2"
        data-composer-row="2"
        data-composer-col="2"
        style="grid-column: 2 / span 2; grid-row: 2; --cf-block-text:#dbe3ee; --cf-block-bg:rgba(15, 23, 42, 0.82); --cf-block-border:rgba(71, 85, 105, 0.7); --cf-block-accent:#7dd3fc;"
        class="cf-composer-activity cf-block-text-override cf-block-bg-override cf-block-border-override cf-block-accent-override"
      >
        
        <article class="rounded-xl border border-emerald-500/30 bg-emerald-950/20 p-6" data-submission-block>
          <h3 class="text-lg font-bold text-emerald-300 mb-3">Generate Unit Submission</h3>
          <div class="flex flex-wrap gap-3">
            <button type="button" class="px-4 py-2 rounded bg-emerald-600 hover:bg-emerald-500 text-white text-xs font-bold uppercase tracking-wide" data-submission-generate>
              Generate Report
            </button>
            <button type="button" class="px-4 py-2 rounded bg-slate-800 hover:bg-slate-700 text-slate-100 text-xs font-bold uppercase tracking-wide" data-submission-copy>
              Copy to Clipboard
            </button>
            <button type="button" class="px-4 py-2 rounded bg-slate-800 hover:bg-slate-700 text-slate-100 text-xs font-bold uppercase tracking-wide" data-submission-download>
              Download TXT
            </button>
            <button type="button" class="px-4 py-2 rounded bg-slate-800 hover:bg-slate-700 text-slate-100 text-xs font-bold uppercase tracking-wide" data-submission-print>
              Print
            </button>
          </div>
          <pre class="mt-4 p-4 rounded bg-slate-950/70 border border-slate-700 text-xs text-slate-200 whitespace-pre-wrap" data-submission-output>Generate your report to view a summary here.</pre>
        </article>
      
      </section>
    

      <section
        data-activity-type="worksheet_form"
        data-activity-id="activity-1771016431221-yv0v3u"
        data-block-theme="default"
        data-composer-col-span="2"
        data-composer-row="5"
        data-composer-col="1"
        style="grid-column: 1 / span 2; grid-row: 5;"
        class="cf-composer-activity"
      >
        
        <article class="rounded-xl border border-slate-700 bg-slate-900/70 p-6" data-worksheet-block>
          
          <div class="space-y-3">
            
                          <section class="rounded-lg border border-indigo-500/30 bg-indigo-950/20 p-4" data-worksheet-segment data-worksheet-kind="title">
                            <h4 class="text-sm font-bold uppercase tracking-wide text-indigo-200">Looking after myself</h4>
                            
                          </section>
                        

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">How much sleep do I need each night?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">Which snacks are the best source of energy for me</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">What times of day do I need to eat?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">What time of the day do I have the most energy?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">What time of the day do I have the least energy?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">What type of exercise makes me feel energized?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">What type of exercise makes me feel tired?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">Field LabelWhat kinds of activities help me relax?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      
          </div>
        </article>
      
      </section>
    

      <section
        data-activity-type="knowledge_check"
        data-activity-id="activity-1771016744631-v6cahr"
        data-block-theme="default"
        data-composer-col-span="1"
        data-composer-row="8"
        data-composer-col="3"
        style="grid-column: 3 / span 1; grid-row: 8;"
        class="cf-composer-activity"
      >
        
        <article class="rounded-xl border border-slate-700 bg-slate-900/70 p-6" data-kc-block data-kc-id="activity-1771016744631-v6cahr">
          <h3 class="text-lg font-bold text-white mb-4">Knowledge Check</h3>
          <div class="space-y-4">
            
                  <section class="rounded-lg border border-slate-700 bg-slate-950/55 p-4" data-kc-question data-kc-kind="multiple_choice" data-kc-question-index="0" data-kc-correct="0">
                    <p class="text-[10px] font-bold uppercase tracking-widest text-slate-500 mb-2">Question 1</p>
                    <h4 class="text-sm font-bold text-white mb-3" data-kc-prompt>Add your question prompt here.</h4>
                    <div class="space-y-2">
                      
                                  <label class="flex items-center gap-3 rounded-lg border border-slate-700 bg-slate-950/70 p-3 text-slate-200">
                                    <input type="radio" name="kc-6-activity-1771016744631-v6cahr-0" value="0" class="w-4 h-4" />
                                    <span>Option A</span>
                                  </label>
                                

                                  <label class="flex items-center gap-3 rounded-lg border border-slate-700 bg-slate-950/70 p-3 text-slate-200">
                                    <input type="radio" name="kc-6-activity-1771016744631-v6cahr-0" value="1" class="w-4 h-4" />
                                    <span>Option B</span>
                                  </label>
                                

                                  <label class="flex items-center gap-3 rounded-lg border border-slate-700 bg-slate-950/70 p-3 text-slate-200">
                                    <input type="radio" name="kc-6-activity-1771016744631-v6cahr-0" value="2" class="w-4 h-4" />
                                    <span>Option C</span>
                                  </label>
                                
                    </div>
                    <div class="mt-4 flex items-center gap-3">
                      <button type="button" class="px-3 py-2 rounded bg-sky-600 hover:bg-sky-500 text-white text-xs font-bold uppercase tracking-wide" data-kc-check>
                        Check Answer
                      </button>
                      <p class="text-xs text-slate-400" data-kc-result></p>
                    </div>
                  </section>
                

                    <section class="rounded-lg border border-emerald-500/25 bg-emerald-950/10 p-4" data-kc-question data-kc-kind="short_answer" data-kc-question-index="1">
                      <p class="text-[10px] font-bold uppercase tracking-widest text-emerald-300 mb-2">Question 2</p>
                      <label class="text-xs font-semibold uppercase tracking-wide text-slate-300 block mb-2" data-kc-prompt>Optional short-answer reflection</label>
                      <textarea
                        class="w-full min-h-28 rounded-lg border border-slate-700 bg-slate-950/70 p-3 text-slate-200"
                        data-kc-short-answer
                        placeholder=""
                      ></textarea>
                    </section>
                  
          </div>
        </article>
      
      </section>
    

      <section
        data-activity-type="worksheet_form"
        data-activity-id="activity-1771018708246-d59t82"
        data-block-theme="default"
        data-composer-col-span="2"
        data-composer-row="6"
        data-composer-col="1"
        style="grid-column: 1 / span 2; grid-row: 6;"
        class="cf-composer-activity"
      >
        
        <article class="rounded-xl border border-slate-700 bg-slate-900/70 p-6" data-worksheet-block>
          
          <div class="space-y-3">
            
                          <section class="rounded-lg border border-indigo-500/30 bg-indigo-950/20 p-4" data-worksheet-segment data-worksheet-kind="title">
                            <h4 class="text-sm font-bold uppercase tracking-wide text-indigo-200">Tool that help me learn</h4>
                            
                          </section>
                        

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">Do I prefer pencils or pens?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">How do I keep my school work organized?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">Do I prefer to write or type my assignments?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">When Iâ€™m working, do I find electronics helpful or distracting?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">Does listening to music help me study?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      
          </div>
        </article>
      
      </section>
    

      <section
        data-activity-type="content_block"
        data-activity-id="activity-1771018779291-1awyug"
        data-block-theme="default"
        data-composer-col-span="4"
        data-composer-row="4"
        data-composer-col="1"
        style="grid-column: 1 / span 4; grid-row: 4;"
        class="cf-composer-activity"
      >
        
        <article class="rounded-xl border border-slate-700 bg-slate-900/70 p-6">
          <style>
            @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&family=Roboto:wght@400;700;900&family=Open+Sans:wght@400;700;800&family=Lato:wght@400;700;900&family=Montserrat:wght@400;700;900&family=Poppins:wght@400;700;900&family=Raleway:wght@400;700;900&family=Nunito:wght@400;700;900&family=Playfair+Display:wght@400;700;900&family=Merriweather:wght@400;700;900&family=Oswald:wght@400;700&family=Bebas+Neue&display=swap');
            .cf-rich-content p { margin: 0.6rem 0; }
            .cf-rich-content ul { list-style: disc; padding-left: 1.5rem; margin: 0.75rem 0; }
            .cf-rich-content ol { list-style: decimal; padding-left: 1.5rem; margin: 0.75rem 0; }
            .cf-rich-content li { margin: 0.35rem 0; }
            .cf-rich-content h1 { font-size: 1.875rem; line-height: 2.25rem; font-weight: 700; margin: 1rem 0 0.5rem; }
            .cf-rich-content h2 { font-size: 1.5rem; line-height: 2rem; font-weight: 700; margin: 0.9rem 0 0.45rem; }
            .cf-rich-content h3 { font-size: 1.25rem; line-height: 1.75rem; font-weight: 700; margin: 0.8rem 0 0.4rem; }
            .cf-rich-content a { color: #7dd3fc; text-decoration: underline; }
            .cf-rich-content blockquote { border-left: 3px solid #475569; margin: 0.9rem 0; padding-left: 0.8rem; opacity: 0.95; }
            .cf-rich-content div { margin: 0.45rem 0; }
            .cf-rich-content font[size='1'] { font-size: 0.75rem; }
            .cf-rich-content font[size='2'] { font-size: 0.875rem; }
            .cf-rich-content font[size='3'] { font-size: 1rem; }
            .cf-rich-content font[size='4'] { font-size: 1.125rem; }
            .cf-rich-content font[size='5'] { font-size: 1.25rem; }
            .cf-rich-content font[size='6'] { font-size: 1.5rem; }
            .cf-rich-content font[size='7'] { font-size: 1.875rem; }
          </style>
          <h3 class="text-xl font-bold text-white mb-3">What Work For Me Inventory</h3>
          <div class="text-slate-200 leading-relaxed cf-rich-content"><p>In the space below, you are asked to consider what you already know about yourself. Think about who you are, what you value, and what works best for you.</p></div>
        </article>
      
      </section>
    

      <section
        data-activity-type="worksheet_form"
        data-activity-id="activity-1771018956322-kupw5y"
        data-block-theme="default"
        data-composer-col-span="2"
        data-composer-row="5"
        data-composer-col="3"
        style="grid-column: 3 / span 2; grid-row: 5;"
        class="cf-composer-activity"
      >
        
        <article class="rounded-xl border border-slate-700 bg-slate-900/70 p-6" data-worksheet-block>
          
          <div class="space-y-3">
            
                          <section class="rounded-lg border border-indigo-500/30 bg-indigo-950/20 p-4" data-worksheet-segment data-worksheet-kind="title">
                            <h4 class="text-sm font-bold uppercase tracking-wide text-indigo-200">In the classroom</h4>
                            
                          </section>
                        

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">Where do I prefer to sit?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">What do I read from best (books, photocopies, screens, whiteboard, etc)?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">Does the colour of the text or paper make a difference?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                        <div data-worksheet-segment data-worksheet-kind="field">
                          <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">Does the size and spacing of the text make a difference?</label>
                          <input type="text" class="w-full rounded border border-slate-700 bg-slate-950/70 p-2 text-sm text-slate-200" placeholder="Answer" />
                        </div>
                      

                          <div data-worksheet-segment data-worksheet-kind="field">
                            <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">Do I prefer to make my own goals, or have a teacher make them for me? Explain.</label>
                            <textarea class="w-full min-h-24 rounded border border-slate-700 bg-slate-950/70 p-3 text-sm text-slate-200" placeholder="Answer"></textarea>
                          </div>
                        
          </div>
        </article>
      
      </section>
    

      <section
        data-activity-type="drag_sort_block"
        data-activity-id="activity-1771019151155-2h25pp"
        data-block-theme="default"
        data-composer-col-span="4"
        data-composer-row="7"
        data-composer-col="1"
        style="grid-column: 1 / span 4; grid-row: 7;"
        class="cf-composer-activity"
      >
        
        <article class="rounded-xl border border-slate-700 bg-slate-900/70 p-6" data-sort-block>
          <h3 class="text-lg font-bold text-white">The directions that work for me</h3>
          <p class="text-sm text-slate-300 mt-2">(rank from 1-5, 1 being the least effective and 5 being the most effective) </p>
          
              <ol class="mt-4 space-y-2" data-sort-list>
                
                    <li class="rounded-lg border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-200 flex items-center justify-between gap-3" data-sort-item draggable="true">
                      <div class="flex items-center gap-2 min-w-0">
                        <span class="text-slate-500 font-mono" data-sort-rank>1.</span>
                        <span class="truncate">Teacher explains out loud</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="-1" title="Move up">Up</button>
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="1" title="Move down">Down</button>
                      </div>
                    </li>
                  

                    <li class="rounded-lg border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-200 flex items-center justify-between gap-3" data-sort-item draggable="true">
                      <div class="flex items-center gap-2 min-w-0">
                        <span class="text-slate-500 font-mono" data-sort-rank>2.</span>
                        <span class="truncate">Teacher writes directions on a separate piece of paper</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="-1" title="Move up">Up</button>
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="1" title="Move down">Down</button>
                      </div>
                    </li>
                  

                    <li class="rounded-lg border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-200 flex items-center justify-between gap-3" data-sort-item draggable="true">
                      <div class="flex items-center gap-2 min-w-0">
                        <span class="text-slate-500 font-mono" data-sort-rank>3.</span>
                        <span class="truncate">Teacher does an example for me</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="-1" title="Move up">Up</button>
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="1" title="Move down">Down</button>
                      </div>
                    </li>
                  

                    <li class="rounded-lg border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-200 flex items-center justify-between gap-3" data-sort-item draggable="true">
                      <div class="flex items-center gap-2 min-w-0">
                        <span class="text-slate-500 font-mono" data-sort-rank>4.</span>
                        <span class="truncate">Teacher asks another student to explain</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="-1" title="Move up">Up</button>
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="1" title="Move down">Down</button>
                      </div>
                    </li>
                  

                    <li class="rounded-lg border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-200 flex items-center justify-between gap-3" data-sort-item draggable="true">
                      <div class="flex items-center gap-2 min-w-0">
                        <span class="text-slate-500 font-mono" data-sort-rank>5.</span>
                        <span class="truncate">Teacher reads the instructions to me</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="-1" title="Move up">Up</button>
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="1" title="Move down">Down</button>
                      </div>
                    </li>
                  

                    <li class="rounded-lg border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-200 flex items-center justify-between gap-3" data-sort-item draggable="true">
                      <div class="flex items-center gap-2 min-w-0">
                        <span class="text-slate-500 font-mono" data-sort-rank>6.</span>
                        <span class="truncate">I read the directions on my own</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="-1" title="Move up">Up</button>
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="1" title="Move down">Down</button>
                      </div>
                    </li>
                  

                    <li class="rounded-lg border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-200 flex items-center justify-between gap-3" data-sort-item draggable="true">
                      <div class="flex items-center gap-2 min-w-0">
                        <span class="text-slate-500 font-mono" data-sort-rank>7.</span>
                        <span class="truncate">I try it on my own and then check with the teacher</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="-1" title="Move up">Up</button>
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="1" title="Move down">Down</button>
                      </div>
                    </li>
                  

                    <li class="rounded-lg border border-slate-700 bg-slate-950/70 px-3 py-2 text-sm text-slate-200 flex items-center justify-between gap-3" data-sort-item draggable="true">
                      <div class="flex items-center gap-2 min-w-0">
                        <span class="text-slate-500 font-mono" data-sort-rank>8.</span>
                        <span class="truncate">I try it on my own and then compare it with another student</span>
                      </div>
                      <div class="flex items-center gap-1">
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="-1" title="Move up">Up</button>
                        <button type="button" class="px-2 py-1 rounded bg-slate-800 hover:bg-slate-700 text-[10px] font-bold text-white" data-sort-move="1" title="Move down">Down</button>
                      </div>
                    </li>
                  
              </ol>
            
          <p class="text-[11px] text-slate-500 mt-3">Tip: drag rows or use Up/Down to reorder.</p>
        </article>
      
      </section>
    

      <section
        data-activity-type="worksheet_form"
        data-activity-id="activity-1771019336755-d4hake"
        data-block-theme="default"
        data-composer-col-span="2"
        data-composer-row="6"
        data-composer-col="3"
        style="grid-column: 3 / span 2; grid-row: 6;"
        class="cf-composer-activity"
      >
        
        <article class="rounded-xl border border-slate-700 bg-slate-900/70 p-6" data-worksheet-block>
          
          <div class="space-y-3">
            
                          <div data-worksheet-segment data-worksheet-kind="field">
                            <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">Tricks I use to keep myself focused on my work:</label>
                            <textarea class="w-full min-h-24 rounded border border-slate-700 bg-slate-950/70 p-3 text-sm text-slate-200" placeholder="Answer"></textarea>
                          </div>
                        

                          <div data-worksheet-segment data-worksheet-kind="field">
                            <label class="block text-xs font-bold uppercase tracking-wide text-slate-400 mb-1">Special things that my teachers can do to help me learn:</label>
                            <textarea class="w-full min-h-24 rounded border border-slate-700 bg-slate-950/70 p-3 text-sm text-slate-200" placeholder="Answer"></textarea>
                          </div>
                        
          </div>
        </article>
      
      </section>
    
    </div>
  
  </main>

  

  <script>
    window.CF_ASSET_BASE_URL = "";
    
    
    (function() {
      if (window.__CF_COMPOSER_RUNTIME_BOUND__) return;
      window.__CF_COMPOSER_RUNTIME_BOUND__ = true;

      function normalizeSpace(value) {
        return String(value || '').replace(/\s+/g, ' ').trim();
      }

      function closest(el, selector) {
        while (el) {
          if (el.matches && el.matches(selector)) return el;
          el = el.parentElement;
        }
        return null;
      }

      function resolveViewerUrl(rawUrl) {
        var url = resolveAssetUrl(rawUrl);
        if (!url) return '';
        if (url.indexOf('docs.google.com/viewer') !== -1) return url;

        function isGoogleSitesHost() {
          var ref = '';
          try { ref = document.referrer || ''; } catch (e) { ref = ''; }
          if (/sites\.google\.com/i.test(ref)) return true;
          try { return /sites\.google\.com/i.test(window.top.location.host || ''); } catch (e) { return /sites\.google\.com/i.test(ref); }
        }

        var clean = String(url).trim();
        if (!clean) return clean;

        // Prefer direct Drive preview URLs.
        var isDrive = /docs\.google\.com|drive\.google\.com/i.test(clean);
        if (isDrive) {
          var driveIdMatch = clean.match(/\/file\/d\/([a-zA-Z0-9_-]+)/i) || clean.match(/[?&]id=([a-zA-Z0-9_-]+)/i);
          if (driveIdMatch && driveIdMatch[1]) {
            return 'https://drive.google.com/file/d/' + driveIdMatch[1] + '/preview';
          }
          if (clean.indexOf('/view') !== -1) {
            return clean.replace('/view', '/preview');
          }
          return clean;
        }

        // Never route local/same-origin URLs through Google Docs Viewer.
        if (/^(\/|\.\/|\.\.\/|blob:|data:)/i.test(clean)) {
          return clean;
        }
        var isSameOrigin = false;
        try {
          var parsed = new URL(clean, window.location.href);
          isSameOrigin = parsed.origin === window.location.origin;
        } catch (e) {
          isSameOrigin = false;
        }
        if (isSameOrigin) {
          return clean;
        }

        // Google Sites embeds often need the Docs viewer, but only for public absolute URLs.
        var forceViewer = isGoogleSitesHost() || window.CF_FORCE_PDF_VIEWER === true;
        if (forceViewer && /^https?:\/\//i.test(clean)) {
          return 'https://docs.google.com/viewer?embedded=true&url=' + encodeURIComponent(clean);
        }

        return clean;
      }

      function resolveAssetUrl(rawUrl) {
        var url = String(rawUrl || '').trim();
        if (!url) return '';

        // Keep absolute/remote URLs untouched.
        if (/^(https?:|data:|blob:|mailto:)/i.test(url)) return url;
        if (/^\/\//.test(url)) return url;

        function smartJoin(base, path) {
          if (!base) return path;
          var baseClean = String(base).replace(/\/$/, '');
          if (!path || !/^\//.test(path)) return baseClean + '/' + path;
          var baseParts = baseClean.split('/');
          var lastBaseSegment = baseParts[baseParts.length - 1];
          if (lastBaseSegment && path.indexOf('/' + lastBaseSegment + '/') === 0) {
            return baseClean + path.substring(lastBaseSegment.length + 1);
          }
          return baseClean + path;
        }

        function normalizeLocalMaterialPath(value) {
          var clean = String(value || '').trim();
          var idx = clean.indexOf('/materials/');
          if (idx !== -1) return clean.substring(idx);
          if (/^materials\//.test(clean)) return '/' + clean;
          return clean;
        }

        function getOriginalLocalMaterialPath(value) {
          var clean = String(value || '').trim();
          var idx = clean.indexOf('/materials/');
          if (idx !== -1) {
            var withPrefix = clean;
            return withPrefix.startsWith('/') ? withPrefix : ('/' + withPrefix);
          }
          if (/^materials\//.test(clean)) return '/' + clean;
          if (/^\/materials\//.test(clean)) return clean;
          return '';
        }

        // Use configured asset base URL when available (Google Sites / CDN).
        var baseUrl = String(window.CF_ASSET_BASE_URL || '').trim().replace(/\/$/, '');
        var materialPath = normalizeLocalMaterialPath(url);
        var originalMaterialPath = getOriginalLocalMaterialPath(url);
        if (baseUrl && /^\/materials\//.test(materialPath)) {
          return smartJoin(baseUrl, materialPath);
        }

        // For embedded/hosted contexts without base URL, prefer preserving the original absolute path.
        if (originalMaterialPath) {
          var pathname = window.location && window.location.pathname ? window.location.pathname : '';
          var host = window.location && window.location.hostname ? window.location.hostname : '';
          var inGoogleEmbed = /googleusercontent\.com|sites\.google\.com/i.test(host) || /\/embeds\//.test(pathname);
          if (inGoogleEmbed) {
            return originalMaterialPath;
          }
        }

        // Normalize known local materials paths so they work in local exported modules and ZIPs.
        if (/^\/materials\//.test(materialPath)) {
          var rel = materialPath.substring(1); // materials/...
          var path = window.location && window.location.pathname ? window.location.pathname : '';
          var inModulesDir = /\/modules\//.test(path) || window.location.protocol === 'file:';
          return inModulesDir ? ('../' + rel) : rel;
        }

        if (/^\//.test(url)) return url;
        return url;
      }

      function getSubmissionContext(target) {
        var block = closest(target, '[data-submission-block]');
        if (!block) return null;
        return {
          block: block,
          output: block.querySelector('[data-submission-output]'),
        };
      }

      function getSaveLoadContext(target) {
        var block = closest(target, '[data-save-load-block]');
        if (!block) return null;
        return {
          block: block,
          root: closest(block, '[data-composer-root]') || document,
          input: block.querySelector('[data-save-load-upload-input]'),
          status: block.querySelector('[data-save-load-status]'),
          fileName: block.getAttribute('data-save-load-file-name') || 'module-progress',
        };
      }

      function setSaveLoadStatus(ctx, message, tone) {
        if (!ctx || !ctx.status) return;
        var normalizedTone = tone === 'error' ? 'error' : tone === 'success' ? 'success' : 'info';
        var toneClass = normalizedTone === 'error' ? 'text-rose-300' : normalizedTone === 'success' ? 'text-emerald-300' : 'text-cyan-100/75';
        ctx.status.className = 'mt-3 text-xs ' + toneClass;
        ctx.status.textContent = message;
      }

      function getPersistableFields(root) {
        return Array.prototype.slice.call(root.querySelectorAll('input, textarea, select')).filter(function(field) {
          if (closest(field, '[data-submission-block]')) return false;
          if (closest(field, '[data-save-load-block]')) return false;
          var tag = String(field.tagName || '').toLowerCase();
          var type = String(field.type || '').toLowerCase();
          if (tag === 'input' && (type === 'hidden' || type === 'file' || type === 'button' || type === 'submit' || type === 'reset' || type === 'image')) {
            return false;
          }
          return true;
        });
      }

      function ensureSortItemIds(list, listIndex) {
        if (!list) return;
        Array.prototype.slice.call(list.querySelectorAll('[data-sort-item]')).forEach(function(item, itemIndex) {
          if (!item.getAttribute('data-sort-item-id')) {
            item.setAttribute('data-sort-item-id', 'sort-' + listIndex + '-item-' + itemIndex);
          }
        });
      }

      function collectInteractiveUiState(root) {
        var tabs = Array.prototype.slice.call(root.querySelectorAll('[data-tabs-block]')).map(function(block) {
          var activeTrigger = block.querySelector('[data-tabs-trigger][aria-selected="true"]');
          if (!activeTrigger) activeTrigger = block.querySelector('[data-tabs-trigger]');
          var idx = parseInt((activeTrigger && activeTrigger.getAttribute('data-tab-index')) || '0', 10);
          return Number.isInteger(idx) ? idx : 0;
        });

        var pathMaps = Array.prototype.slice.call(root.querySelectorAll('[data-path-map-block]')).map(function(block) {
          var activeNode = block.querySelector('[data-path-node].ring-1') || block.querySelector('[data-path-node]');
          var idx = parseInt((activeNode && activeNode.getAttribute('data-path-index')) || '0', 10);
          return Number.isInteger(idx) ? idx : 0;
        });

        var hotspots = Array.prototype.slice.call(root.querySelectorAll('[data-hotspot-block]')).map(function(block) {
          var activeButton = block.querySelector('[data-hotspot-btn].bg-sky-500') || block.querySelector('[data-hotspot-btn]');
          var idx = parseInt((activeButton && activeButton.getAttribute('data-hotspot-index')) || '0', 10);
          return Number.isInteger(idx) ? idx : 0;
        });

        var flashcards = Array.prototype.slice.call(root.querySelectorAll('[data-flashcards-block]')).map(function(block) {
          return Array.prototype.slice
            .call(block.querySelectorAll('[data-flashcard]'))
            .map(function(card, cardIndex) {
              return card.getAttribute('data-flashcard-side') === 'back' ? cardIndex : null;
            })
            .filter(function(index) { return index !== null; });
        });

        var sortLists = Array.prototype.slice.call(root.querySelectorAll('[data-sort-list]')).map(function(list, listIndex) {
          ensureSortItemIds(list, listIndex);
          return Array.prototype.slice
            .call(list.querySelectorAll('[data-sort-item]'))
            .map(function(item) { return item.getAttribute('data-sort-item-id') || ''; })
            .filter(Boolean);
        });

        return {
          tabs: tabs,
          pathMaps: pathMaps,
          hotspots: hotspots,
          flashcards: flashcards,
          sortLists: sortLists,
        };
      }

      function applyInteractiveUiState(root, uiState) {
        var state = uiState && typeof uiState === 'object' ? uiState : {};

        Array.prototype.slice.call(root.querySelectorAll('[data-tabs-block]')).forEach(function(block, idx) {
          if (!Array.isArray(state.tabs)) return;
          var next = parseInt(state.tabs[idx], 10);
          if (!Number.isInteger(next)) return;
          setActiveTab(block, next);
        });

        Array.prototype.slice.call(root.querySelectorAll('[data-path-map-block]')).forEach(function(block, idx) {
          if (!Array.isArray(state.pathMaps)) return;
          var next = parseInt(state.pathMaps[idx], 10);
          if (!Number.isInteger(next)) return;
          setPathMapIndex(block, next);
        });

        Array.prototype.slice.call(root.querySelectorAll('[data-hotspot-block]')).forEach(function(block, idx) {
          if (!Array.isArray(state.hotspots)) return;
          var next = parseInt(state.hotspots[idx], 10);
          if (!Number.isInteger(next)) return;
          setHotspotIndex(block, next);
        });

        Array.prototype.slice.call(root.querySelectorAll('[data-flashcards-block]')).forEach(function(block, idx) {
          var openIndexes = Array.isArray(state.flashcards) && Array.isArray(state.flashcards[idx]) ? state.flashcards[idx] : [];
          var openSet = new Set(openIndexes.map(function(value) { return parseInt(value, 10); }));
          Array.prototype.slice.call(block.querySelectorAll('[data-flashcard]')).forEach(function(card, cardIndex) {
            setFlashcardFace(card, openSet.has(cardIndex));
          });
        });

        Array.prototype.slice.call(root.querySelectorAll('[data-sort-list]')).forEach(function(list, listIndex) {
          ensureSortItemIds(list, listIndex);
          if (!(Array.isArray(state.sortLists) && Array.isArray(state.sortLists[listIndex]))) return;
          var desiredOrder = state.sortLists[listIndex];
          var byId = {};
          Array.prototype.slice.call(list.querySelectorAll('[data-sort-item]')).forEach(function(item) {
            byId[item.getAttribute('data-sort-item-id') || ''] = item;
          });
          desiredOrder.forEach(function(itemId) {
            var item = byId[itemId];
            if (item) list.appendChild(item);
          });
          refreshSortRanks(list);
        });
      }

      function collectModuleProgressSnapshot(root) {
        var fields = getPersistableFields(root).map(function(field) {
          var tag = String(field.tagName || '').toLowerCase();
          var type = String(field.type || '').toLowerCase();
          if (type === 'checkbox' || type === 'radio') {
            return {
              tag: tag,
              type: type,
              checked: Boolean(field.checked),
            };
          }
          return {
            tag: tag,
            type: type,
            value: String(field.value || ''),
          };
        });

        return {
          kind: 'course-factory-module-progress',
          version: 1,
          savedAt: new Date().toISOString(),
          fields: fields,
          ui: collectInteractiveUiState(root),
        };
      }

      function applyModuleProgressSnapshot(root, snapshot) {
        if (!snapshot || typeof snapshot !== 'object') {
          return { ok: false, message: 'Invalid progress payload.' };
        }
        var records = Array.isArray(snapshot.fields) ? snapshot.fields : [];
        if (!records.length) {
          return { ok: false, message: 'No saved fields found in this file.' };
        }

        var fields = getPersistableFields(root);
        var appliedCount = 0;
        records.forEach(function(record, idx) {
          var field = fields[idx];
          if (!field) return;
          var tag = String(field.tagName || '').toLowerCase();
          var type = String(field.type || '').toLowerCase();
          if (type === 'checkbox' || type === 'radio') {
            field.checked = Boolean(record && record.checked);
            appliedCount += 1;
            return;
          }
          var nextValue = record && Object.prototype.hasOwnProperty.call(record, 'value') ? String(record.value || '') : '';
          field.value = nextValue;
          appliedCount += 1;
          if (tag === 'select' || type === 'range') return;
        });

        applyInteractiveUiState(root, snapshot.ui || {});

        Array.prototype.slice.call(root.querySelectorAll('[data-checklist-block]')).forEach(function(block) {
          refreshChecklistBlock(block, true);
        });
        Array.prototype.slice.call(root.querySelectorAll('[data-before-after-block]')).forEach(function(block) {
          refreshBeforeAfterBlock(block);
        });
        Array.prototype.slice.call(root.querySelectorAll('[data-decision-block]')).forEach(function(block) {
          refreshDecisionBlock(block);
        });
        Array.prototype.slice.call(root.querySelectorAll('[data-rubric-block]')).forEach(function(block) {
          refreshRubricBlock(block);
        });

        return { ok: true, message: 'Restored ' + appliedCount + ' fields from backup.' };
      }

      function downloadModuleProgressSnapshot(ctx, snapshot) {
        var baseName = String((ctx && ctx.fileName) || 'module-progress').replace(/[^a-z0-9._-]/gi, '-').trim() || 'module-progress';
        var fileName = /\.json$/i.test(baseName) ? baseName : (baseName + '.json');
        var blob = new Blob([JSON.stringify(snapshot, null, 2)], { type: 'application/json;charset=utf-8' });
        var link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        setTimeout(function() {
          URL.revokeObjectURL(link.href);
        }, 500);
      }

      function getReadableText(el, fallback) {
        if (!el) return fallback || '';
        var text = normalizeSpace(el.innerText || el.textContent || '');
        return text || fallback || '';
      }

      function getSectionTitle(section, fallback) {
        if (!section) return fallback || 'Section';
        var titleEl = section.querySelector('h3, h2, h4');
        return getReadableText(titleEl, fallback || 'Section');
      }

      function readFieldLabel(field, scope, fallback) {
        if (!field) return fallback || 'Response';
        var labelEl = null;
        var id = field.id;
        if (id) {
          try {
            labelEl = scope.querySelector('label[for="' + id.replace(/"/g, '\"') + '"]');
          } catch (err) {
            labelEl = null;
          }
        }
        if (!labelEl) labelEl = closest(field, 'label');
        var raw = labelEl ? getReadableText(labelEl, '') : '';
        if (!raw && field.getAttribute) raw = normalizeSpace(field.getAttribute('aria-label') || '');
        if (!raw) raw = normalizeSpace(field.name || field.id || field.placeholder || '');
        return raw || fallback || 'Response';
      }

      function readFieldValue(field) {
        if (!field) return '';
        var tag = String(field.tagName || '').toLowerCase();
        var type = String(field.type || '').toLowerCase();
        if (type === 'checkbox') return field.checked ? 'Yes' : '';
        if (tag === 'select') {
          var selected = field.options && field.selectedIndex >= 0 ? field.options[field.selectedIndex] : null;
          var selectedText = selected ? normalizeSpace(selected.innerText || selected.text || '') : '';
          return selectedText || normalizeSpace(field.value || '');
        }
        return normalizeSpace(field.value || '');
      }

      function formatNumericValue(value) {
        var parsed = Number(value);
        if (!Number.isFinite(parsed)) return '0';
        var rounded = Math.round(parsed * 100) / 100;
        return String(rounded);
      }

      function collectFilledFieldLines(scope, options) {
        var config = options || {};
        var lines = [];
        var textFields = Array.prototype.slice.call(
          scope.querySelectorAll('input:not([type="hidden"]):not([type="radio"]):not([type="checkbox"]), textarea, select'),
        );
        textFields.forEach(function(field, idx) {
          if (closest(field, '[data-submission-block]')) return;
          if (Array.isArray(config.excludeSelectors) && config.excludeSelectors.some(function(selector) { return closest(field, selector); })) return;
          var value = readFieldValue(field);
          if (!value) return;
          var fallbackLabel = 'Response ' + (idx + 1);
          var label = readFieldLabel(field, scope, fallbackLabel);
          lines.push(label + ': ' + value);
        });

        if (config.includeCheckedCheckboxes !== false) {
          var checkboxes = Array.prototype.slice.call(scope.querySelectorAll('input[type="checkbox"]'));
          checkboxes.forEach(function(field) {
            if (closest(field, '[data-submission-block]')) return;
            if (Array.isArray(config.excludeSelectors) && config.excludeSelectors.some(function(selector) { return closest(field, selector); })) return;
            if (!field.checked) return;
            var label = readFieldLabel(field, scope, 'Checkbox');
            lines.push(label + ': Yes');
          });
        }

        if (config.includeRadioSelections !== false) {
          var radios = Array.prototype.slice.call(scope.querySelectorAll('input[type="radio"]'));
          var radioGroups = {};
          radios.forEach(function(field, idx) {
            if (closest(field, '[data-submission-block]')) return;
            if (Array.isArray(config.excludeSelectors) && config.excludeSelectors.some(function(selector) { return closest(field, selector); })) return;
            var key = field.name || ('__radio_' + idx);
            if (!radioGroups[key]) radioGroups[key] = [];
            radioGroups[key].push(field);
          });
          Object.keys(radioGroups).forEach(function(key) {
            var group = radioGroups[key];
            if (!group || !group.length) return;
            var selected = null;
            group.forEach(function(field) {
              if (field.checked) selected = field;
            });
            if (!selected) return;
            var optionWrap = closest(selected, 'label');
            var optionText = optionWrap ? getReadableText(optionWrap, '') : '';
            if (!optionText) optionText = normalizeSpace(selected.value || 'Selected');
            var label = key && key.indexOf('__radio_') !== 0 ? key : 'Selected Option';
            lines.push(label + ': ' + optionText);
          });
        }

        return lines;
      }

      function pushReportSection(targetLines, title, lines) {
        if (!lines || !lines.length) return;
        targetLines.push('[' + title + ']');
        lines.forEach(function(line) {
          targetLines.push('- ' + line);
        });
        targetLines.push('');
      }

      function buildSubmissionReport(root) {
        var reportLines = [];
        var sections = Array.prototype.slice.call(root.querySelectorAll('[data-activity-type]'));

        sections.forEach(function(section, sectionIdx) {
          var type = normalizeSpace(section.getAttribute('data-activity-type') || '').toLowerCase();
          if (!type || type === 'submission_builder' || type === 'save_load_block') return;
          var title = getSectionTitle(section, 'Activity ' + (sectionIdx + 1));
          var lines = [];

          if (type === 'knowledge_check') {
            var block = section.querySelector('[data-kc-block]');
            if (!block) return;
            var title = getReadableText(block.querySelector('h3'), 'Knowledge Check');
            lines.push('Set: ' + title);
            var questionNodes = Array.prototype.slice.call(block.querySelectorAll('[data-kc-question]'));
            if (questionNodes.length) {
              questionNodes.forEach(function(questionNode, qIdx) {
                var kind = normalizeSpace(questionNode.getAttribute('data-kc-kind') || '').toLowerCase();
                var prompt = getReadableText(questionNode.querySelector('[data-kc-prompt]'), 'Question ' + (qIdx + 1));
                if (kind === 'short_answer') {
                  var responseField = questionNode.querySelector('[data-kc-short-answer]');
                  var responseText = normalizeSpace((responseField && responseField.value) || '');
                  lines.push('Q' + (qIdx + 1) + ': ' + prompt);
                  lines.push('Response: ' + (responseText || '[No response]'));
                  return;
                }
                var selected = questionNode.querySelector('input[type="radio"]:checked');
                var selectedLabel = '[No selection]';
                var outcome = 'Not answered';
                if (selected) {
                  var labelWrap = closest(selected, 'label');
                  selectedLabel = labelWrap ? getReadableText(labelWrap, 'Option ' + (selected.value || '?')) : ('Option ' + (selected.value || '?'));
                  var correct = parseInt(questionNode.getAttribute('data-kc-correct') || '0', 10);
                  var picked = parseInt(selected.value || '-1', 10);
                  if (!isNaN(correct) && !isNaN(picked)) {
                    outcome = picked === correct ? 'Correct' : 'Incorrect';
                  }
                }
                lines.push('Q' + (qIdx + 1) + ': ' + prompt);
                lines.push('Selected Answer: ' + selectedLabel);
                lines.push('Result: ' + outcome);
              });
            } else {
              // Legacy knowledge-check markup fallback.
              var prompt = getReadableText(block.querySelector('h3'), 'Knowledge Check');
              var selected = block.querySelector('input[type="radio"]:checked');
              var selectedLabel = '[No selection]';
              var outcome = 'Not answered';
              if (selected) {
                var labelWrap = closest(selected, 'label');
                selectedLabel = labelWrap ? getReadableText(labelWrap, 'Option ' + (selected.value || '?')) : ('Option ' + (selected.value || '?'));
                var correct = parseInt(block.getAttribute('data-kc-correct') || '0', 10);
                var picked = parseInt(selected.value || '-1', 10);
                if (!isNaN(correct) && !isNaN(picked)) {
                  outcome = picked === correct ? 'Correct' : 'Incorrect';
                }
              }
              lines.push('Prompt: ' + prompt);
              lines.push('Selected Answer: ' + selectedLabel);
              lines.push('Result: ' + outcome);
              var shortAnswer = block.querySelector('[data-kc-short-answer]');
              if (shortAnswer) {
                var shortAnswerText = normalizeSpace(shortAnswer.value || '');
                lines.push('Reflection: ' + (shortAnswerText || '[No response]'));
              }
            }
          } else if (type === 'checklist_block') {
            var checklist = section.querySelector('[data-checklist-block]');
            if (!checklist) return;
            var checklistInputs = Array.prototype.slice.call(checklist.querySelectorAll('[data-checklist-input]'));
            var checkedCount = checklistInputs.filter(function(input) { return input.checked; }).length;
            var total = checklistInputs.length;
            lines.push('Progress: ' + checkedCount + ' / ' + total + ' complete');
            checklistInputs.forEach(function(input) {
              var row = closest(input, 'label');
              var textEl = row ? row.querySelector('span') : null;
              var itemText = getReadableText(textEl, 'Checklist item');
              lines.push((input.checked ? '[x] ' : '[ ] ') + itemText);
            });
          } else if (type === 'drag_sort_block') {
            var sortList = section.querySelector('[data-sort-list]');
            if (!sortList) return;
            var sortItems = Array.prototype.slice.call(sortList.querySelectorAll('[data-sort-item]'));
            if (!sortItems.length) return;
            lines.push('Current Order:');
            sortItems.forEach(function(item, idx) {
              var labelEl = item.querySelector('div span:last-child');
              var itemText = getReadableText(labelEl, getReadableText(item, 'Item ' + (idx + 1)));
              itemText = normalizeSpace(itemText.replace(/\bUp\b/g, '').replace(/\bDown\b/g, ''));
              lines.push(String(idx + 1) + '. ' + itemText);
            });
          } else if (type === 'reflection_journal') {
            var reflectionPrompt = getReadableText(section.querySelector('p'), 'Reflection Prompt');
            var reflectionInput = section.querySelector('textarea');
            var reflectionValue = normalizeSpace((reflectionInput && reflectionInput.value) || '');
            lines.push('Prompt: ' + reflectionPrompt);
            lines.push('Response: ' + (reflectionValue || '[No response]'));
          } else if (type === 'worksheet_form') {
            lines = collectFilledFieldLines(section, { includeCheckedCheckboxes: false, includeRadioSelections: false });
            if (!lines.length) lines.push('No worksheet fields filled yet.');
          } else if (type === 'portfolio_evidence') {
            var artifactInput = section.querySelector('input[type="text"]');
            var summaryInput = section.querySelector('textarea');
            var artifactValue = normalizeSpace((artifactInput && artifactInput.value) || '');
            var summaryValue = normalizeSpace((summaryInput && summaryInput.value) || '');
            lines.push('Artifact URL: ' + (artifactValue || '[Not provided]'));
            lines.push('Evidence Summary: ' + (summaryValue || '[Not provided]'));
            var checkedCriteria = Array.prototype.slice
              .call(section.querySelectorAll('input[type="checkbox"]'))
              .filter(function(field) { return field.checked; })
              .map(function(field) { return readFieldLabel(field, section, 'Criteria'); });
            lines.push('Self-Check Criteria Met: ' + (checkedCriteria.length ? checkedCriteria.join('; ') : '[None selected]'));
          } else if (type === 'roleplay_simulator') {
            var rolePrompt = getReadableText(section.querySelector('label'), 'Your response');
            var roleInput = section.querySelector('textarea');
            var roleValue = normalizeSpace((roleInput && roleInput.value) || '');
            lines.push('Prompt: ' + rolePrompt);
            lines.push('Response: ' + (roleValue || '[No response]'));
          } else if (type === 'decision_lab') {
            var decisionInputs = Array.prototype.slice.call(section.querySelectorAll('[data-decision-input]'));
            if (!decisionInputs.length) return;
            decisionInputs.forEach(function(input) {
              var card = closest(input, '.rounded-lg');
              var name = getReadableText(card ? card.querySelector('p') : null, 'Variable');
              var weight = normalizeSpace(input.getAttribute('data-decision-weight') || '1');
              var min = normalizeSpace(input.getAttribute('data-decision-min') || '');
              var max = normalizeSpace(input.getAttribute('data-decision-max') || '');
              var value = normalizeSpace(input.value || '');
              lines.push(name + ': ' + value + ' (range ' + min + '-' + max + ', weight ' + weight + ')');
            });
            var score = getReadableText(section.querySelector('[data-decision-score]'), '');
            if (score) lines.push('Projected Outcome Score: ' + score);
          } else if (type === 'rubric_creator') {
            var rubricBlock = section.querySelector('[data-rubric-block]');
            if (!rubricBlock) return;
            var rubricRows = Array.prototype.slice.call(rubricBlock.querySelectorAll('tr[data-rubric-row]'));
            var totalScore = 0;
            rubricRows.forEach(function(row, rowIdx) {
              var rowLabel = getReadableText(row.querySelector('[data-rubric-row-label]'), 'Criterion ' + (rowIdx + 1));
              var selectedChoice = row.querySelector('[data-rubric-choice]:checked');
              if (!selectedChoice) {
                lines.push(rowLabel + ': [No selection]');
                return;
              }
              var scoreValue = Number(selectedChoice.getAttribute('data-rubric-score') || selectedChoice.value);
              if (Number.isFinite(scoreValue)) totalScore += scoreValue;
              var colIdx = parseInt(selectedChoice.getAttribute('data-rubric-col') || '-1', 10);
              var descriptor = '';
              if (Number.isInteger(colIdx) && colIdx >= 0) {
                var cell = row.querySelector('[data-rubric-cell][data-rubric-col="' + colIdx + '"]');
                descriptor = getReadableText(cell ? cell.querySelector('p') : null, '');
              }
              lines.push(rowLabel + ': Score ' + formatNumericValue(scoreValue) + (descriptor ? ' - ' + descriptor : ''));
            });
            var maxText = getReadableText(rubricBlock.querySelector('[data-rubric-max]'), '');
            lines.push('Total: ' + formatNumericValue(totalScore) + (maxText ? ' / ' + maxText : ''));
          } else if (type === 'before_after') {
            var slider = section.querySelector('[data-before-after-slider]');
            var beforeLabel = getReadableText(section.querySelector('[data-before-panel] p'), 'Before');
            var afterLabel = getReadableText(section.querySelector('[data-after-panel] p'), 'After');
            var afterPercent = parseInt((slider && slider.value) || '50', 10);
            if (isNaN(afterPercent)) afterPercent = 50;
            afterPercent = Math.max(0, Math.min(100, afterPercent));
            var beforePercent = 100 - afterPercent;
            lines.push('Comparison Split: ' + beforeLabel + ' ' + beforePercent + ' / ' + afterLabel + ' ' + afterPercent);
          } else if (type === 'tabs_block') {
            var activeTabPanel = section.querySelector('[data-tabs-panel]:not(.hidden)');
            if (activeTabPanel) {
              var activeTabLabel = getReadableText(activeTabPanel.querySelector('h4'), 'Tab');
              lines.push('Active Tab: ' + activeTabLabel);
            }
          } else if (type === 'path_map') {
            var activePath = section.querySelector('[data-path-panel]:not(.hidden)');
            if (activePath) {
              lines.push('Selected Path: ' + getReadableText(activePath.querySelector('h4'), 'Path'));
            }
          } else if (type === 'hotspot_image') {
            var activeHotspot = section.querySelector('[data-hotspot-panel]:not(.hidden)');
            if (activeHotspot) {
              lines.push('Selected Hotspot: ' + getReadableText(activeHotspot.querySelector('p'), 'Hotspot'));
            }
          } else if (type === 'flashcard_deck') {
            var cards = Array.prototype.slice.call(section.querySelectorAll('[data-flashcard]'));
            if (cards.length) {
              var flipped = cards.filter(function(card) { return card.getAttribute('data-flashcard-side') === 'back'; }).length;
              lines.push('Cards Flipped: ' + flipped + ' / ' + cards.length);
            }
          } else if (type === 'scenario_branch' || type === 'accordion_block') {
            var openItems = Array.prototype.slice
              .call(section.querySelectorAll('details[open] summary'))
              .map(function(summary) { return getReadableText(summary, 'Open item'); })
              .filter(Boolean);
            if (openItems.length) {
              lines.push('Expanded Items: ' + openItems.join('; '));
            }
          } else {
            lines = collectFilledFieldLines(section, {});
          }

          pushReportSection(reportLines, title, lines);
        });

        if (!reportLines.length) {
          return 'No responses found to include in this report yet. Fill in one or more activity inputs and generate again.';
        }

        var header = [
          'Course Factory Submission Report',
          'Generated: ' + new Date().toLocaleString(),
          '',
        ];
        return header.concat(reportLines).join('\n').trim();
      }

      function escapeForHtml(value) {
        return String(value || '')
          .replace(/&/g, '&amp;')
          .replace(/</g, '&lt;')
          .replace(/>/g, '&gt;')
          .replace(/"/g, '&quot;')
          .replace(/'/g, '&#39;');
      }

      function decodeDataAttrJson(raw) {
        if (!raw) return null;
        try {
          return JSON.parse(decodeURIComponent(raw));
        } catch (e) {
          return null;
        }
      }

      var resourceReaderState = null;

      function getReaderRefs(card) {
        if (!card) return null;
        return {
          card: card,
          panel: card.querySelector('[data-resource-reader]'),
          title: card.querySelector('[data-resource-reader-title]'),
          toc: card.querySelector('[data-resource-reader-toc]'),
          body: card.querySelector('[data-resource-reader-body]'),
          progress: card.querySelector('[data-resource-reader-progress]'),
          prevBtn: card.querySelector('[data-resource-reader-prev]'),
          nextBtn: card.querySelector('[data-resource-reader-next]'),
        };
      }

      function renderReaderToc(state) {
        if (!state || !state.refs || !state.refs.toc) return;
        var tocHtml = state.chapters
          .map(function(chapter, idx) {
            var chapterTitle = escapeForHtml(chapter && chapter.title ? chapter.title : ('Chapter ' + (idx + 1)));
            var chapterNumber = escapeForHtml(chapter && chapter.number ? String(chapter.number) : String(idx + 1));
            var isActive = idx === state.index;
            var btnClass = isActive
              ? 'w-full text-left px-3 py-2 rounded text-xs font-bold bg-emerald-600/20 border border-emerald-500/40 text-emerald-300'
              : 'w-full text-left px-3 py-2 rounded text-xs font-semibold text-slate-300 hover:bg-slate-800 border border-transparent';
            return '<button type="button" class="' + btnClass + '" data-resource-reader-chapter="' + idx + '">' + chapterNumber + '. ' + chapterTitle + '</button>';
          })
          .join('');
        state.refs.toc.innerHTML = tocHtml;
      }

      function renderReaderChapter(state) {
        if (!state || !state.refs || !state.refs.body) return;
        if (!state.chapters.length) {
          state.refs.body.innerHTML = '<p class="text-sm text-slate-300">No chapters found.</p>';
          if (state.refs.progress) state.refs.progress.textContent = '';
          if (state.refs.prevBtn) state.refs.prevBtn.disabled = true;
          if (state.refs.nextBtn) state.refs.nextBtn.disabled = true;
          renderReaderToc(state);
          return;
        }

        if (state.index < 0) state.index = 0;
        if (state.index > state.chapters.length - 1) state.index = state.chapters.length - 1;

        var chapter = state.chapters[state.index] || {};
        var chapterTitle = escapeForHtml(chapter.title || ('Chapter ' + (state.index + 1)));
        var chapterNumber = escapeForHtml(chapter.number ? String(chapter.number) : String(state.index + 1));
        var sections = Array.isArray(chapter.sections) ? chapter.sections : [];
        var sectionsHtml = sections
          .map(function(section) {
            var heading = escapeForHtml(section && section.heading ? section.heading : '');
            var body = escapeForHtml(section && section.content ? section.content : '').replace(/\n/g, '<br>');
            return '<section class="mt-5">' +
              (heading ? '<h5 class="text-sm font-bold text-emerald-300 mb-2">' + heading + '</h5>' : '') +
              '<div class="text-sm text-slate-200 leading-relaxed">' + body + '</div>' +
            '</section>';
          })
          .join('');

        var resourceTitle = escapeForHtml(state.content && state.content.title ? state.content.title : 'Digital Resource');
        state.refs.body.innerHTML =
          '<h3 class="text-xl font-bold text-white mb-1">' + resourceTitle + '</h3>' +
          '<p class="text-xs uppercase tracking-widest text-slate-400 mb-4">Chapter ' + (state.index + 1) + ' of ' + state.chapters.length + '</p>' +
          '<h4 class="text-lg font-bold text-white border-b border-slate-800 pb-2">' + chapterNumber + '. ' + chapterTitle + '</h4>' +
          sectionsHtml;

        if (state.refs.progress) {
          state.refs.progress.textContent = 'Chapter ' + (state.index + 1) + ' / ' + state.chapters.length;
        }
        if (state.refs.prevBtn) state.refs.prevBtn.disabled = state.index === 0;
        if (state.refs.nextBtn) state.refs.nextBtn.disabled = state.index === state.chapters.length - 1;
        renderReaderToc(state);
      }

      function openResourceReader(card, titleText, payload) {
        var refs = getReaderRefs(card);
        if (!refs || !refs.panel || !refs.body) return;
        var content = payload && typeof payload === 'object' ? payload : {};
        var chapters = Array.isArray(content.chapters) ? content.chapters : [];
        resourceReaderState = {
          refs: refs,
          content: content,
          chapters: chapters,
          index: 0,
        };
        refs.panel.classList.remove('hidden');
        if (refs.title) {
          refs.title.textContent = 'Digital Resource: ' + (titleText || content.title || 'Read');
        }
        renderReaderChapter(resourceReaderState);
      }

      function closeResourceReader(card) {
        var refs = getReaderRefs(card);
        if (!refs || !refs.panel) return;
        refs.panel.classList.add('hidden');
        if (refs.body) refs.body.innerHTML = '';
        if (refs.toc) refs.toc.innerHTML = '';
        resourceReaderState = null;
      }

      function safeStorageGet(key) {
        if (!key) return '';
        try {
          return window.localStorage ? window.localStorage.getItem(key) : '';
        } catch (err) {
          return '';
        }
      }

      function safeStorageSet(key, value) {
        if (!key) return;
        try {
          if (window.localStorage) window.localStorage.setItem(key, value);
        } catch (err) {
          // Ignore storage permission/availability errors.
        }
      }

      function getChecklistStorageKey(block) {
        if (!block) return '';
        var rawId = (block.getAttribute('data-checklist-id') || '').trim();
        if (!rawId) return '';
        return 'cf_checklist_v1_' + rawId.replace(/[^a-z0-9_-]/gi, '_');
      }

      function refreshChecklistBlock(block, shouldPersist) {
        if (!block) return;
        var inputs = Array.prototype.slice.call(block.querySelectorAll('[data-checklist-input]'));
        var checkedIndices = [];
        inputs.forEach(function(input, idx) {
          if (input.checked) checkedIndices.push(idx);
          var row = closest(input, 'label');
          if (!row) return;
          var text = row.querySelector('span');
          if (!text) return;
          text.classList.toggle('line-through', input.checked);
          text.classList.toggle('text-slate-500', input.checked);
        });
        var total = parseInt(block.getAttribute('data-checklist-total') || String(inputs.length), 10);
        if (!Number.isFinite(total) || total < 0) total = inputs.length;
        var progress = block.querySelector('[data-checklist-progress]');
        if (progress) progress.textContent = checkedIndices.length + ' / ' + total + ' done';
        if (shouldPersist) {
          safeStorageSet(
            getChecklistStorageKey(block),
            JSON.stringify({
              checked: checkedIndices,
              updatedAt: Date.now(),
            }),
          );
        }
      }

      function restoreChecklistBlock(block) {
        if (!block) return;
        var raw = safeStorageGet(getChecklistStorageKey(block));
        if (raw) {
          try {
            var parsed = JSON.parse(raw);
            var checked = parsed && Array.isArray(parsed.checked) ? parsed.checked : [];
            var checkSet = new Set(checked.map(function(idx) { return parseInt(idx, 10); }).filter(function(idx) { return Number.isInteger(idx) && idx >= 0; }));
            Array.prototype.slice.call(block.querySelectorAll('[data-checklist-input]')).forEach(function(input, idx) {
              input.checked = checkSet.has(idx);
            });
          } catch (err) {
            // Ignore malformed saved checklist JSON.
          }
        }
        refreshChecklistBlock(block, false);
      }

      function setActiveTab(block, nextIndex) {
        if (!block) return;
        var triggers = Array.prototype.slice.call(block.querySelectorAll('[data-tabs-trigger]'));
        var panels = Array.prototype.slice.call(block.querySelectorAll('[data-tabs-panel]'));
        if (!triggers.length || !panels.length) return;
        var hasMatch = triggers.some(function(trigger) {
          return parseInt(trigger.getAttribute('data-tab-index') || '-1', 10) === nextIndex;
        });
        var active = hasMatch ? nextIndex : parseInt(triggers[0].getAttribute('data-tab-index') || '0', 10);
        triggers.forEach(function(trigger) {
          var idx = parseInt(trigger.getAttribute('data-tab-index') || '-1', 10);
          var isActive = idx === active;
          trigger.setAttribute('aria-selected', isActive ? 'true' : 'false');
          trigger.classList.toggle('ring-1', isActive);
          trigger.classList.toggle('ring-indigo-400', isActive);
          trigger.classList.toggle('border-indigo-500', isActive);
          trigger.classList.toggle('text-white', isActive);
          trigger.classList.toggle('border-slate-700', !isActive);
          trigger.classList.toggle('text-slate-200', !isActive);
        });
        panels.forEach(function(panel) {
          var idx = parseInt(panel.getAttribute('data-tab-index') || '-1', 10);
          panel.classList.toggle('hidden', idx !== active);
        });
      }

      function setFlashcardFace(card, showBack) {
        if (!card) return;
        var front = card.querySelector('[data-flashcard-front]');
        var back = card.querySelector('[data-flashcard-back]');
        var toggleBtn = card.querySelector('[data-flashcard-toggle]');
        if (front) front.classList.toggle('hidden', showBack);
        if (back) back.classList.toggle('hidden', !showBack);
        card.setAttribute('data-flashcard-side', showBack ? 'back' : 'front');
        if (toggleBtn) toggleBtn.textContent = showBack ? 'Show Front' : 'Show Back';
      }

      function setPathMapIndex(block, nextIndex) {
        if (!block) return;
        var nodes = Array.prototype.slice.call(block.querySelectorAll('[data-path-node]'));
        var panels = Array.prototype.slice.call(block.querySelectorAll('[data-path-panel]'));
        if (!nodes.length || !panels.length) return;
        var hasMatch = nodes.some(function(node) {
          return parseInt(node.getAttribute('data-path-index') || '-1', 10) === nextIndex;
        });
        var active = hasMatch ? nextIndex : parseInt(nodes[0].getAttribute('data-path-index') || '0', 10);
        nodes.forEach(function(node) {
          var idx = parseInt(node.getAttribute('data-path-index') || '-1', 10);
          var isActive = idx === active;
          node.classList.toggle('ring-1', isActive);
          node.classList.toggle('ring-indigo-400', isActive);
          node.classList.toggle('border-indigo-500', isActive);
          node.classList.toggle('text-white', isActive);
          node.classList.toggle('border-slate-700', !isActive);
          node.classList.toggle('text-slate-200', !isActive);
        });
        panels.forEach(function(panel) {
          var idx = parseInt(panel.getAttribute('data-path-index') || '-1', 10);
          panel.classList.toggle('hidden', idx !== active);
        });
      }

      function setHotspotIndex(block, nextIndex) {
        if (!block) return;
        var buttons = Array.prototype.slice.call(block.querySelectorAll('[data-hotspot-btn]'));
        var panels = Array.prototype.slice.call(block.querySelectorAll('[data-hotspot-panel]'));
        if (!buttons.length || !panels.length) return;
        var hasMatch = buttons.some(function(btn) {
          return parseInt(btn.getAttribute('data-hotspot-index') || '-1', 10) === nextIndex;
        });
        var active = hasMatch ? nextIndex : parseInt(buttons[0].getAttribute('data-hotspot-index') || '0', 10);
        buttons.forEach(function(btn) {
          var idx = parseInt(btn.getAttribute('data-hotspot-index') || '-1', 10);
          var isActive = idx === active;
          btn.classList.toggle('border-sky-300', isActive);
          btn.classList.toggle('bg-sky-500', isActive);
          btn.classList.toggle('text-slate-950', isActive);
          btn.classList.toggle('border-slate-200/80', !isActive);
          btn.classList.toggle('bg-slate-900/85', !isActive);
          btn.classList.toggle('text-white', !isActive);
        });
        panels.forEach(function(panel) {
          var idx = parseInt(panel.getAttribute('data-hotspot-index') || '-1', 10);
          panel.classList.toggle('hidden', idx !== active);
        });
      }

      function refreshBeforeAfterBlock(block) {
        if (!block) return;
        var slider = block.querySelector('[data-before-after-slider]');
        if (!slider) return;
        var raw = parseInt(slider.value || '50', 10);
        var afterPct = Number.isFinite(raw) ? Math.max(0, Math.min(100, raw)) : 50;
        var beforePct = 100 - afterPct;
        var beforePanel = block.querySelector('[data-before-panel]');
        var afterPanel = block.querySelector('[data-after-panel]');
        if (beforePanel) beforePanel.style.opacity = String((Math.max(20, beforePct) / 100).toFixed(2));
        if (afterPanel) afterPanel.style.opacity = String((Math.max(20, afterPct) / 100).toFixed(2));
        var valueEl = block.querySelector('[data-before-after-value]');
        if (valueEl) valueEl.textContent = beforePct + ' / ' + afterPct;
      }

      function refreshDecisionBlock(block) {
        if (!block) return;
        var inputs = Array.prototype.slice.call(block.querySelectorAll('[data-decision-input]'));
        if (!inputs.length) return;
        var totalWeight = 0;
        var weightedSum = 0;
        inputs.forEach(function(input) {
          var min = Number(input.getAttribute('data-decision-min'));
          var max = Number(input.getAttribute('data-decision-max'));
          var weight = Number(input.getAttribute('data-decision-weight'));
          var safeMin = Number.isFinite(min) ? min : 0;
          var safeMax = Number.isFinite(max) && max >= safeMin ? max : safeMin + 10;
          var safeWeight = Number.isFinite(weight) && weight > 0 ? weight : 1;
          var value = Number(input.value);
          var clamped = Number.isFinite(value) ? Math.max(safeMin, Math.min(safeMax, value)) : safeMin;
          if (String(clamped) !== String(input.value)) input.value = String(clamped);
          var normalized = safeMax === safeMin ? 0 : (clamped - safeMin) / (safeMax - safeMin);
          weightedSum += normalized * safeWeight;
          totalWeight += safeWeight;
          var key = input.getAttribute('data-decision-key') || '';
          if (key) {
            var current = block.querySelector('[data-decision-current][data-decision-key="' + key + '"]');
            if (current) current.textContent = String(clamped);
          }
        });
        var score = totalWeight > 0 ? Math.round((weightedSum / totalWeight) * 100) : 0;
        var scoreEl = block.querySelector('[data-decision-score]');
        if (scoreEl) scoreEl.textContent = String(score);
      }

      function refreshRubricBlock(block) {
        if (!block) return;
        var choices = Array.prototype.slice.call(block.querySelectorAll('[data-rubric-choice]'));
        var total = 0;
        choices.forEach(function(choice) {
          var row = parseInt(choice.getAttribute('data-rubric-row') || '-1', 10);
          var col = parseInt(choice.getAttribute('data-rubric-col') || '-1', 10);
          var cell = null;
          if (Number.isInteger(row) && Number.isInteger(col) && row >= 0 && col >= 0) {
            cell = block.querySelector('[data-rubric-cell][data-rubric-row="' + row + '"][data-rubric-col="' + col + '"]');
          }
          if (cell) {
            cell.classList.toggle('ring-1', choice.checked);
            cell.classList.toggle('ring-emerald-400', choice.checked);
            cell.classList.toggle('bg-emerald-900/20', choice.checked);
          }
          if (choice.checked) {
            var score = Number(choice.getAttribute('data-rubric-score') || choice.value);
            if (Number.isFinite(score)) total += score;
          }
        });
        var totalEl = block.querySelector('[data-rubric-total]');
        if (totalEl) totalEl.textContent = formatNumericValue(total);
      }

      function getSortContext(target) {
        var item = closest(target, '[data-sort-item]');
        if (!item) return null;
        var list = closest(item, '[data-sort-list]');
        if (!list) return null;
        return { item: item, list: list };
      }

      function refreshSortRanks(list) {
        if (!list) return;
        Array.prototype.slice.call(list.querySelectorAll('[data-sort-item]')).forEach(function(item, idx) {
          var rank = item.querySelector('[data-sort-rank]');
          if (rank) rank.textContent = String(idx + 1) + '.';
        });
      }

      function moveSortItem(item, offset) {
        if (!item || !offset) return;
        var list = closest(item, '[data-sort-list]');
        if (!list) return;
        var allLists = Array.prototype.slice.call(document.querySelectorAll('[data-sort-list]'));
        var listIndex = allLists.indexOf(list);
        ensureSortItemIds(list, listIndex >= 0 ? listIndex : 0);
        var items = Array.prototype.slice.call(list.querySelectorAll('[data-sort-item]'));
        var fromIndex = items.indexOf(item);
        if (fromIndex < 0) return;
        var toIndex = Math.max(0, Math.min(items.length - 1, fromIndex + offset));
        if (toIndex === fromIndex) return;
        if (toIndex > fromIndex) {
          list.insertBefore(item, items[toIndex].nextSibling);
        } else {
          list.insertBefore(item, items[toIndex]);
        }
        refreshSortRanks(list);
      }

      function initializeComposerRuntime() {
        Array.prototype.slice.call(document.querySelectorAll('[data-checklist-block]')).forEach(function(block) {
          restoreChecklistBlock(block);
        });
        Array.prototype.slice.call(document.querySelectorAll('[data-tabs-block]')).forEach(function(block) {
          var first = block.querySelector('[data-tabs-trigger]');
          var start = first ? parseInt(first.getAttribute('data-tab-index') || '0', 10) : 0;
          setActiveTab(block, start);
        });
        Array.prototype.slice.call(document.querySelectorAll('[data-flashcard]')).forEach(function(card) {
          setFlashcardFace(card, false);
        });
        Array.prototype.slice.call(document.querySelectorAll('[data-path-map-block]')).forEach(function(block) {
          var first = block.querySelector('[data-path-node]');
          var start = first ? parseInt(first.getAttribute('data-path-index') || '0', 10) : 0;
          setPathMapIndex(block, start);
        });
        Array.prototype.slice.call(document.querySelectorAll('[data-hotspot-block]')).forEach(function(block) {
          var first = block.querySelector('[data-hotspot-btn]');
          var start = first ? parseInt(first.getAttribute('data-hotspot-index') || '0', 10) : 0;
          setHotspotIndex(block, start);
        });
        Array.prototype.slice.call(document.querySelectorAll('[data-before-after-block]')).forEach(function(block) {
          refreshBeforeAfterBlock(block);
        });
        Array.prototype.slice.call(document.querySelectorAll('[data-decision-block]')).forEach(function(block) {
          refreshDecisionBlock(block);
        });
        Array.prototype.slice.call(document.querySelectorAll('[data-rubric-block]')).forEach(function(block) {
          refreshRubricBlock(block);
        });
        Array.prototype.slice.call(document.querySelectorAll('[data-sort-list]')).forEach(function(list, listIndex) {
          ensureSortItemIds(list, listIndex);
          refreshSortRanks(list);
        });
      }

      var activeSortDragItem = null;
      var activeSortDropTarget = null;

      document.addEventListener('click', function(event) {
        var checkBtn = closest(event.target, '[data-kc-check]');
        if (checkBtn) {
          var questionScope = closest(checkBtn, '[data-kc-question]');
          var block = closest(checkBtn, '[data-kc-block]');
          var scope = questionScope || block;
          if (!scope) return;
          var correct = parseInt(scope.getAttribute('data-kc-correct') || '0', 10);
          var chosen = scope.querySelector('input[type="radio"]:checked');
          var resultEl = scope.querySelector('[data-kc-result]');
          if (!chosen) {
            if (resultEl) resultEl.textContent = 'Select an option first.';
            return;
          }
          var selected = parseInt(chosen.value, 10);
          var isCorrect = selected === correct;
          if (resultEl) {
            resultEl.textContent = isCorrect ? 'Correct.' : 'Try again.';
            resultEl.className = isCorrect ? 'text-xs text-emerald-300' : 'text-xs text-rose-300';
          }
          return;
        }

        var tabTrigger = closest(event.target, '[data-tabs-trigger]');
        if (tabTrigger) {
          var tabBlock = closest(tabTrigger, '[data-tabs-block]');
          if (!tabBlock) return;
          var tabIndex = parseInt(tabTrigger.getAttribute('data-tab-index') || '0', 10);
          setActiveTab(tabBlock, Number.isFinite(tabIndex) ? tabIndex : 0);
          return;
        }

        var flashcardToggle = closest(event.target, '[data-flashcard-toggle]');
        if (flashcardToggle) {
          var flashcard = closest(flashcardToggle, '[data-flashcard]');
          if (!flashcard) return;
          var showBack = flashcard.getAttribute('data-flashcard-side') !== 'back';
          setFlashcardFace(flashcard, showBack);
          return;
        }

        var pathNode = closest(event.target, '[data-path-node]');
        if (pathNode) {
          var pathBlock = closest(pathNode, '[data-path-map-block]');
          if (!pathBlock) return;
          var pathIndex = parseInt(pathNode.getAttribute('data-path-index') || '0', 10);
          setPathMapIndex(pathBlock, Number.isFinite(pathIndex) ? pathIndex : 0);
          return;
        }

        var hotspotBtn = closest(event.target, '[data-hotspot-btn]');
        if (hotspotBtn) {
          var hotspotBlock = closest(hotspotBtn, '[data-hotspot-block]');
          if (!hotspotBlock) return;
          var hotspotIndex = parseInt(hotspotBtn.getAttribute('data-hotspot-index') || '0', 10);
          setHotspotIndex(hotspotBlock, Number.isFinite(hotspotIndex) ? hotspotIndex : 0);
          return;
        }

        var sortMoveBtn = closest(event.target, '[data-sort-move]');
        if (sortMoveBtn) {
          var sortContext = getSortContext(sortMoveBtn);
          if (!sortContext) return;
          var delta = parseInt(sortMoveBtn.getAttribute('data-sort-move') || '0', 10);
          if (!Number.isFinite(delta)) return;
          moveSortItem(sortContext.item, delta);
          return;
        }

        var rubricClearBtn = closest(event.target, '[data-rubric-clear]');
        if (rubricClearBtn) {
          var rubricBlock = closest(rubricClearBtn, '[data-rubric-block]');
          if (!rubricBlock) return;
          Array.prototype.slice.call(rubricBlock.querySelectorAll('[data-rubric-choice]')).forEach(function(choice) {
            choice.checked = false;
          });
          refreshRubricBlock(rubricBlock);
          return;
        }

        var viewResourceBtn = closest(event.target, '[data-resource-view]');
        if (viewResourceBtn) {
          var resourceCard = closest(viewResourceBtn, 'article');
          if (!resourceCard) return;
          var viewer = resourceCard.querySelector('[data-resource-viewer]');
          var frame = resourceCard.querySelector('[data-resource-viewer-frame]');
          var title = resourceCard.querySelector('[data-resource-viewer-title]');
          var rawUrl = viewResourceBtn.getAttribute('data-resource-url') || '';
          if (!viewer || !frame || !rawUrl) return;
          frame.src = resolveViewerUrl(rawUrl);
          if (title) title.textContent = 'Viewing: ' + (viewResourceBtn.getAttribute('data-resource-title') || 'Resource');
          viewer.classList.remove('hidden');
          return;
        }

        var closeResourceBtn = closest(event.target, '[data-resource-viewer-close]');
        if (closeResourceBtn) {
          var closeCard = closest(closeResourceBtn, 'article');
          if (!closeCard) return;
          var closeViewer = closeCard.querySelector('[data-resource-viewer]');
          var closeFrame = closeCard.querySelector('[data-resource-viewer-frame]');
          if (closeFrame) closeFrame.src = '';
          if (closeViewer) closeViewer.classList.add('hidden');
          return;
        }

        var readResourceBtn = closest(event.target, '[data-resource-read]');
        if (readResourceBtn) {
          var readCard = closest(readResourceBtn, 'article');
          if (!readCard) return;
          var payload = decodeDataAttrJson(readResourceBtn.getAttribute('data-resource-read-content') || '');
          openResourceReader(readCard, readResourceBtn.getAttribute('data-resource-read-title') || 'Read', payload);
          return;
        }

        var closeReaderBtn = closest(event.target, '[data-resource-reader-close]');
        if (closeReaderBtn) {
          var closeReadCard = closest(closeReaderBtn, 'article');
          if (!closeReadCard) return;
          closeResourceReader(closeReadCard);
          return;
        }

        var tocChapterBtn = closest(event.target, '[data-resource-reader-chapter]');
        if (tocChapterBtn && resourceReaderState) {
          var idx = parseInt(tocChapterBtn.getAttribute('data-resource-reader-chapter') || '0', 10);
          if (!isNaN(idx)) {
            resourceReaderState.index = idx;
            renderReaderChapter(resourceReaderState);
          }
          return;
        }

        var prevReaderBtn = closest(event.target, '[data-resource-reader-prev]');
        if (prevReaderBtn && resourceReaderState) {
          resourceReaderState.index = Math.max(0, resourceReaderState.index - 1);
          renderReaderChapter(resourceReaderState);
          return;
        }

        var nextReaderBtn = closest(event.target, '[data-resource-reader-next]');
        if (nextReaderBtn && resourceReaderState) {
          resourceReaderState.index = Math.min(resourceReaderState.chapters.length - 1, resourceReaderState.index + 1);
          renderReaderChapter(resourceReaderState);
          return;
        }

        var downloadResourceBtn = closest(event.target, '[data-resource-download]');
        if (downloadResourceBtn) {
          var rawDownloadUrl = downloadResourceBtn.getAttribute('data-resource-download-url') || '';
          var downloadUrl = resolveAssetUrl(rawDownloadUrl);
          if (!downloadUrl) return;
          var downloadName = (downloadResourceBtn.getAttribute('data-resource-download-name') || 'resource').replace(/[^a-z0-9._ -]/gi, '');
          var link = document.createElement('a');
          link.href = downloadUrl;
          link.target = '_blank';
          link.rel = 'noopener noreferrer';
          link.setAttribute('download', downloadName || 'resource');
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          return;
        }

        var saveLoadDownloadBtn = closest(event.target, '[data-save-load-download]');
        if (saveLoadDownloadBtn) {
          var saveCtx = getSaveLoadContext(saveLoadDownloadBtn);
          if (!saveCtx || !saveCtx.root) return;
          try {
            var snapshot = collectModuleProgressSnapshot(saveCtx.root);
            downloadModuleProgressSnapshot(saveCtx, snapshot);
            setSaveLoadStatus(saveCtx, 'Backup downloaded (' + new Date().toLocaleTimeString() + ').', 'success');
          } catch (err) {
            setSaveLoadStatus(saveCtx, 'Could not create backup JSON.', 'error');
          }
          return;
        }

        var saveLoadUploadTriggerBtn = closest(event.target, '[data-save-load-upload-trigger]');
        if (saveLoadUploadTriggerBtn) {
          var uploadCtx = getSaveLoadContext(saveLoadUploadTriggerBtn);
          if (!uploadCtx || !uploadCtx.input) return;
          uploadCtx.input.value = '';
          uploadCtx.input.click();
          setSaveLoadStatus(uploadCtx, 'Select a JSON backup file to restore.', 'info');
          return;
        }

        var generateBtn = closest(event.target, '[data-submission-generate]');
        if (generateBtn) {
          var submissionContext = getSubmissionContext(generateBtn);
          if (!submissionContext || !submissionContext.output) return;
          var root = closest(generateBtn, '[data-composer-root]') || document;
          var reportText = buildSubmissionReport(root);
          submissionContext.output.textContent = reportText;
          return;
        }

        var copyBtn = closest(event.target, '[data-submission-copy]');
        if (copyBtn) {
          var copyContext = getSubmissionContext(copyBtn);
          var out = copyContext ? copyContext.output : null;
          if (!out) return;
          var text = out.textContent || '';
          if (!text.trim()) return;
          if (navigator.clipboard && navigator.clipboard.writeText) {
            navigator.clipboard.writeText(text).catch(function() {});
          } else {
            var ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            try { document.execCommand('copy'); } catch (e) {}
            document.body.removeChild(ta);
          }
          return;
        }

        var downloadBtn = closest(event.target, '[data-submission-download]');
        if (downloadBtn) {
          var downloadContext = getSubmissionContext(downloadBtn);
          var downloadOut = downloadContext ? downloadContext.output : null;
          if (!downloadOut) return;
          var downloadText = downloadOut.textContent || '';
          if (!downloadText.trim()) return;
          var blob = new Blob([downloadText], { type: 'text/plain;charset=utf-8' });
          var link = document.createElement('a');
          link.href = URL.createObjectURL(blob);
          link.download = 'module-report.txt';
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
          setTimeout(function() {
            URL.revokeObjectURL(link.href);
          }, 500);
          return;
        }

        var printBtn = closest(event.target, '[data-submission-print]');
        if (printBtn) {
          var printContext = getSubmissionContext(printBtn);
          var printOut = printContext ? printContext.output : null;
          if (!printOut) return;
          var printText = printOut.textContent || '';
          if (!printText.trim()) return;
          var win = window.open('', '_blank');
          if (!win) return;
          win.document.write('<!DOCTYPE html><html><head><title>Module Report</title><style>body{font-family:Arial,sans-serif;padding:24px;line-height:1.4;}pre{white-space:pre-wrap;}</style></head><body><h1>Module Report</h1><pre>' + escapeForHtml(printText) + '</pre></body></html>');
          win.document.close();
          win.focus();
          win.print();
        }
      });

      document.addEventListener('change', function(event) {
        var checklistInput = closest(event.target, '[data-checklist-input]');
        if (checklistInput) {
          var checklistBlock = closest(checklistInput, '[data-checklist-block]');
          if (!checklistBlock) return;
          refreshChecklistBlock(checklistBlock, true);
          return;
        }

        var rubricChoiceInput = closest(event.target, '[data-rubric-choice]');
        if (rubricChoiceInput) {
          var rubricChoiceBlock = closest(rubricChoiceInput, '[data-rubric-block]');
          if (!rubricChoiceBlock) return;
          refreshRubricBlock(rubricChoiceBlock);
          return;
        }

        var uploadInput = closest(event.target, '[data-save-load-upload-input]');
        if (uploadInput) {
          var uploadCtx = getSaveLoadContext(uploadInput);
          if (!uploadCtx || !uploadCtx.root) return;
          var file = uploadInput.files && uploadInput.files[0];
          if (!file) {
            setSaveLoadStatus(uploadCtx, 'Upload canceled.', 'info');
            return;
          }
          file
            .text()
            .then(function(text) {
              var parsed = null;
              try {
                parsed = JSON.parse(text);
              } catch {
                setSaveLoadStatus(uploadCtx, 'Invalid JSON file. Could not parse backup.', 'error');
                return;
              }
              var payload = parsed;
              if (parsed && typeof parsed === 'object' && parsed.kind && parsed.kind !== 'course-factory-module-progress') {
                setSaveLoadStatus(uploadCtx, 'Unsupported backup type for this module.', 'error');
                return;
              }
              if (parsed && typeof parsed === 'object' && parsed.payload && typeof parsed.payload === 'object') {
                payload = parsed.payload;
              }
              var result = applyModuleProgressSnapshot(uploadCtx.root, payload);
              setSaveLoadStatus(uploadCtx, result.message, result.ok ? 'success' : 'error');
            })
            .catch(function() {
              setSaveLoadStatus(uploadCtx, 'Failed to read selected backup file.', 'error');
            });
        }
      });

      document.addEventListener('input', function(event) {
        var beforeAfterSlider = closest(event.target, '[data-before-after-slider]');
        if (beforeAfterSlider) {
          var beforeAfterBlock = closest(beforeAfterSlider, '[data-before-after-block]');
          if (!beforeAfterBlock) return;
          refreshBeforeAfterBlock(beforeAfterBlock);
          return;
        }

        var decisionInput = closest(event.target, '[data-decision-input]');
        if (decisionInput) {
          var decisionBlock = closest(decisionInput, '[data-decision-block]');
          if (!decisionBlock) return;
          refreshDecisionBlock(decisionBlock);
        }
      });

      document.addEventListener('dragstart', function(event) {
        var sortItem = closest(event.target, '[data-sort-item]');
        if (!sortItem) return;
        activeSortDragItem = sortItem;
        sortItem.classList.add('opacity-70');
        if (event.dataTransfer) {
          event.dataTransfer.effectAllowed = 'move';
          event.dataTransfer.setData('text/plain', 'sort-item');
        }
      });

      document.addEventListener('dragover', function(event) {
        if (!activeSortDragItem) return;
        var overItem = closest(event.target, '[data-sort-item]');
        var overList = overItem ? closest(overItem, '[data-sort-list]') : closest(event.target, '[data-sort-list]');
        if (!overList) return;
        event.preventDefault();
        if (event.dataTransfer) event.dataTransfer.dropEffect = 'move';
        if (activeSortDropTarget && activeSortDropTarget !== overItem) {
          activeSortDropTarget.classList.remove('ring-1', 'ring-indigo-400');
        }
        if (overItem && overItem !== activeSortDragItem) {
          overItem.classList.add('ring-1', 'ring-indigo-400');
          activeSortDropTarget = overItem;
        } else {
          activeSortDropTarget = null;
        }
      });

      document.addEventListener('drop', function(event) {
        if (!activeSortDragItem) return;
        var targetItem = closest(event.target, '[data-sort-item]');
        var targetList = targetItem ? closest(targetItem, '[data-sort-list]') : closest(event.target, '[data-sort-list]');
        if (!targetList) return;
        event.preventDefault();
        if (activeSortDropTarget) {
          activeSortDropTarget.classList.remove('ring-1', 'ring-indigo-400');
          activeSortDropTarget = null;
        }
        if (!targetItem || targetItem === activeSortDragItem) {
          targetList.appendChild(activeSortDragItem);
          refreshSortRanks(targetList);
          return;
        }
        var rect = targetItem.getBoundingClientRect();
        var insertAfter = event.clientY > rect.top + rect.height / 2;
        if (insertAfter) {
          targetList.insertBefore(activeSortDragItem, targetItem.nextSibling);
        } else {
          targetList.insertBefore(activeSortDragItem, targetItem);
        }
        refreshSortRanks(targetList);
      });

      document.addEventListener('dragend', function() {
        if (activeSortDropTarget) {
          activeSortDropTarget.classList.remove('ring-1', 'ring-indigo-400');
          activeSortDropTarget = null;
        }
        if (activeSortDragItem) {
          activeSortDragItem.classList.remove('opacity-70');
          var owningList = closest(activeSortDragItem, '[data-sort-list]');
          if (owningList) refreshSortRanks(owningList);
          activeSortDragItem = null;
        }
      });

      initializeComposerRuntime();
    })();
  
    
(function() {
  var MODULE_KEY = 'CF_Module_Module_1__Personal_Choices_v1';
  var saveTimeout = null;
  function getAllInputState() {
    var state = {};
    document.querySelectorAll('input, textarea, select').forEach(function(el, i) {
      var key = el.id || el.name || ('field_' + i);
      if (el.type === 'checkbox' || el.type === 'radio') {
        if (el.checked) state[key] = el.type === 'radio' ? el.value : true;
      } else {
        if (el.value) state[key] = el.value;
      }
    });
    return state;
  }
  function restoreInputState(state) {
    if (!state || typeof state !== 'object') return;
    document.querySelectorAll('input, textarea, select').forEach(function(el, i) {
      var key = el.id || el.name || ('field_' + i);
      var savedValue = state[key];
      if (savedValue !== undefined) {
        if (el.type === 'checkbox') {
          el.checked = !!savedValue;
        } else if (el.type === 'radio') {
          el.checked = (el.value === savedValue);
        } else {
          el.value = savedValue;
        }
      }
    });
  }
  function saveNow() {
    try {
      var state = getAllInputState();
      if (Object.keys(state).length > 0) {
        localStorage.setItem(MODULE_KEY, JSON.stringify({
          timestamp: Date.now(),
          state: state
        }));
      }
    } catch (e) {}
  }
  function debouncedSave() {
    clearTimeout(saveTimeout);
    saveTimeout = setTimeout(saveNow, 800);
  }
  function loadSaved() {
    try {
      var raw = localStorage.getItem(MODULE_KEY);
      if (raw) {
        var parsed = JSON.parse(raw);
        if (parsed && parsed.state) restoreInputState(parsed.state);
      }
    } catch (e) {}
  }
  function init() {
    loadSaved();
    document.addEventListener('input', debouncedSave);
    document.addEventListener('change', debouncedSave);
    window.addEventListener('pagehide', saveNow);
  }
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
  </script>
</body>
</html>